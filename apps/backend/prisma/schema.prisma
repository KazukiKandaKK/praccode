generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザー
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  password      String?   // Credentials認証用（ハッシュ化）
  image         String?
  role          UserRole  @default(LEARNER)
  emailVerified DateTime? @map("email_verified") // メール認証済み日時
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  submissions               Submission[]
  hints                     Hint[]
  createdExercises          Exercise[]                @relation("CreatedExercises")
  assignedExercises         Exercise[]                @relation("AssignedExercises")
  createdWritingChallenges  WritingChallenge[]        @relation("CreatedWritingChallenges")
  assignedWritingChallenges WritingChallenge[]        @relation("AssignedWritingChallenges")
  accounts                  Account[]
  sessions                  Session[]
  emailChangeTokens         EmailChangeToken[]
  emailVerificationTokens   EmailVerificationToken[]
  passwordResetTokens       PasswordResetToken[]
  writingSubmissions        WritingSubmission[]
  learningAnalysis          UserLearningAnalysis?
  learningPlans             LearningPlan[]
  mentorFeedbacks           MentorFeedbackLog[]
  learningTimeLogs          LearningTimeLog[]
  mentorWorkflowState       MentorWorkflowState?
  evaluationMetrics         EvaluationMetric[]
  mentorFeedbackInsights    MentorFeedbackInsight[]
  mentorSprints             MentorSprint[]

  @@map("users")
}

enum UserRole {
  ADMIN
  LEARNER
}

enum MentorWorkflowStep {
  PLAN
  DO
  CHECK
  NEXT_PLAN
}

enum MentorSprintStatus {
  ACTIVE
  COMPLETED
}

enum EvaluationMetricSource {
  READING
  WRITING
}

enum MentorFeedbackInsightType {
  STRENGTH
  IMPROVEMENT
}

// NextAuth.js用アカウント
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth.js用セッション
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// メール変更（確認リンク用）
model EmailChangeToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  newEmail  String   @map("new_email")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_change_tokens")
}

// メール認証（登録確認用）
model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

// 学習（問題）
model Exercise {
  id             String         @id @default(uuid())
  title          String
  language       String         // typescript, go, ruby, etc.
  difficulty     Int            // 1-5
  genre          String?        // auth, database, error_handling, ...
  status         ExerciseStatus @default(READY) // GENERATING, READY, FAILED
  sourceType     String         @default("embedded") @map("source_type")
  sourceUrl      String?        @map("source_url")
  code           String         @db.Text
  learningGoals  Json           @default("[]") @map("learning_goals")
  createdById    String         @map("created_by_id")
  assignedToId   String?        @map("assigned_to_id") // 排他的に割り当てられたユーザーID
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  createdBy   User                       @relation("CreatedExercises", fields: [createdById], references: [id])
  assignedTo  User?                      @relation("AssignedExercises", fields: [assignedToId], references: [id])
  questions   ExerciseReferenceAnswer[]
  submissions Submission[]
  hints       Hint[]

  @@index([assignedToId])
  @@map("exercises")
}

// 設問と模範回答
model ExerciseReferenceAnswer {
  id                String   @id @default(uuid())
  exerciseId        String   @map("exercise_id")
  questionIndex     Int      @map("question_index")
  questionText      String   @map("question_text") @db.Text
  idealAnswerPoints Json     @default("[]") @map("ideal_answer_points")
  createdAt         DateTime @default(now()) @map("created_at")

  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, questionIndex])
  @@map("exercise_reference_answers")
}

// 回答提出
model Submission {
  id         String           @id @default(uuid())
  exerciseId String           @map("exercise_id")
  userId     String           @map("user_id")
  status     SubmissionStatus @default(DRAFT)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  exercise Exercise           @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers  SubmissionAnswer[]
  mentorFeedbacks MentorFeedbackLog[]
  evaluationMetrics EvaluationMetric[]

  @@map("submissions")
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  EVALUATED
}

enum ExerciseStatus {
  GENERATING
  READY
  FAILED
}

// 個別の回答
model SubmissionAnswer {
  id            String   @id @default(uuid())
  submissionId  String   @map("submission_id")
  questionIndex Int      @map("question_index")
  answerText    String   @default("") @map("answer_text") @db.Text
  score         Int?
  level         String?  // A, B, C, D
  llmFeedback   String?  @map("llm_feedback") @db.Text
  aspects       Json?    // { responsibility: 80, data_flow: 60, ... }
  createdAt     DateTime @default(now()) @map("created_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, questionIndex])
  @@map("submission_answers")
}

// ヒント履歴
model Hint {
  id            String   @id @default(uuid())
  exerciseId    String   @map("exercise_id")
  userId        String   @map("user_id")
  questionIndex Int      @map("question_index")
  hintText      String   @map("hint_text") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("hints")
}

// ========== コードライティング ==========

// ライティングお題
model WritingChallenge {
  id          String                  @id @default(uuid())
  title       String                  @default("")
  description String                  @default("") @db.Text
  language    String                  // javascript, typescript, python, go
  difficulty  Int                     @default(1) // 1-5
  status      WritingChallengeStatus  @default(READY)
  testCode    String                  @default("") @map("test_code") @db.Text // テストケース
  starterCode String?                 @map("starter_code") @db.Text // ユーザー用の初期コード
  sampleCode  String?                 @map("sample_code") @db.Text // 参考実装（非公開）
  createdById String?                 @map("created_by_id")
  assignedToId String?                @map("assigned_to_id") // 排他的に割り当てられたユーザーID
  createdAt   DateTime                @default(now()) @map("created_at")
  updatedAt   DateTime                @updatedAt @map("updated_at")

  createdBy   User?               @relation("CreatedWritingChallenges", fields: [createdById], references: [id])
  assignedTo  User?                @relation("AssignedWritingChallenges", fields: [assignedToId], references: [id])
  submissions WritingSubmission[]

  @@index([assignedToId])
  @@map("writing_challenges")
}

enum WritingChallengeStatus {
  GENERATING
  READY
  FAILED
}

// ライティング提出
model WritingSubmission {
  id                String                 @id @default(uuid())
  challengeId       String                 @map("challenge_id")
  userId            String                 @map("user_id")
  language          String                 // 使用言語
  code              String                 @db.Text
  status            WritingSubmissionStatus @default(PENDING)
  stdout            String?                @db.Text
  stderr            String?                @db.Text
  exitCode          Int?                   @map("exit_code")
  passed            Boolean?
  executedAt        DateTime?              @map("executed_at")
  llmFeedback       String?                @map("llm_feedback") @db.Text
  llmFeedbackStatus String                 @map("llm_feedback_status") @default("NOT_STARTED") // NOT_STARTED, GENERATING, COMPLETED, FAILED
  llmFeedbackAt     DateTime?              @map("llm_feedback_at")
  createdAt         DateTime               @default(now()) @map("created_at")

  challenge        WritingChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  evaluationMetrics EvaluationMetric[]

  @@map("writing_submissions")
}

enum WritingSubmissionStatus {
  PENDING    // 実行待ち
  RUNNING    // 実行中
  COMPLETED  // 完了（成功/失敗問わず）
  ERROR      // 実行エラー（タイムアウト等）
}

// ========== 学習分析 ==========

// ユーザーの学習分析結果
model UserLearningAnalysis {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  strengths       Json     @default("[]") // ["責務理解が優れている", "エラーハンドリングの意識が高い"]
  weaknesses      Json     @default("[]") // ["データフローの追跡が弱い"]
  recommendations Json     @default("[]") // ["データフロー系の問題に挑戦", "..."]
  summary         String   @default("") @db.Text // LLMによる総評
  analyzedAt      DateTime @default(now()) @map("analyzed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_learning_analyses")
}

// ========== 学習計画 ==========

model LearningPlan {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  plan           Json
  presetAnswers  Json     @default("[]") @map("preset_answers")
  targetLanguage String?  @map("target_language")
  modelId        String?  @map("model_id")
  temperature    Float?   @map("temperature")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentorSprints MentorSprint[]

  @@index([userId])
  @@map("learning_plans")
}

model MentorFeedbackLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  submissionId String   @map("submission_id")
  feedback     Json
  modelId      String?  @map("model_id")
  temperature  Float?   @map("temperature")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  insights   MentorFeedbackInsight[]

  @@index([userId])
  @@index([submissionId])
  @@map("mentor_feedback_logs")
}

model LearningTimeLog {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  source      String
  durationSec Int      @map("duration_sec")
  startedAt   DateTime @default(now()) @map("started_at")
  endedAt     DateTime @default(now()) @map("ended_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@map("learning_time_logs")
}

model EvaluationMetric {
  id                  String                 @id @default(uuid())
  userId              String                 @map("user_id")
  sourceType          EvaluationMetricSource @map("source_type")
  aspect              String
  score               Int
  submissionId        String?                @map("submission_id")
  writingSubmissionId String?                @map("writing_submission_id")
  createdAt           DateTime               @default(now()) @map("created_at")

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  submission        Submission?       @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  writingSubmission WritingSubmission? @relation(fields: [writingSubmissionId], references: [id], onDelete: Cascade)

  @@index([userId, sourceType, createdAt])
  @@index([submissionId])
  @@index([writingSubmissionId])
  @@map("evaluation_metrics")
}

model MentorFeedbackInsight {
  id              String                   @id @default(uuid())
  userId          String                   @map("user_id")
  mentorFeedbackId String                  @map("mentor_feedback_id")
  type            MentorFeedbackInsightType @map("type")
  label           String
  detail          String?                  @db.Text
  example         String?                  @db.Text
  createdAt       DateTime                 @default(now()) @map("created_at")

  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentorFeedback MentorFeedbackLog @relation(fields: [mentorFeedbackId], references: [id], onDelete: Cascade)

  @@index([userId, type, createdAt])
  @@index([mentorFeedbackId])
  @@map("mentor_feedback_insights")
}

model MentorSprint {
  id             String              @id @default(uuid())
  userId         String              @map("user_id")
  learningPlanId String?             @map("learning_plan_id")
  sequence       Int
  goal           String              @db.Text
  focusAreas     Json                @default("[]") @map("focus_areas")
  startDate      DateTime            @map("start_date")
  endDate        DateTime            @map("end_date")
  status         MentorSprintStatus  @default(ACTIVE)
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningPlan LearningPlan? @relation(fields: [learningPlanId], references: [id], onDelete: SetNull)

  @@index([userId, status, startDate])
  @@map("mentor_sprints")
}

model MentorWorkflowState {
  id          String             @id @default(uuid())
  userId      String             @unique @map("user_id")
  currentStep MentorWorkflowStep @map("current_step")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mentor_workflow_states")
}

// ========== Mastra Memory ==========

model MastraThread {
  id         String          @id @default(uuid())
  resourceId String          @map("resource_id")
  title      String?
  metadata   Json?
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  messages MastraMessage[]

  @@index([resourceId])
  @@map("mastra_threads")
}

model MastraMessage {
  id          String   @id @default(uuid())
  threadId    String   @map("thread_id")
  role        String
  content     Json
  type        String   @default("text")
  toolCallIds Json?    @map("tool_call_ids")
  toolCallArgs Json?   @map("tool_call_args")
  toolNames   Json?    @map("tool_names")
  createdAt   DateTime @default(now()) @map("created_at")

  thread MastraThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@map("mastra_messages")
}
